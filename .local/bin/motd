#!/bin/bash
IFS=" " read LOAD1 LOAD5 LOAD15 <<<$(cat /proc/loadavg | awk '{ print $1,$2,$3 }')
# get free memory
IFS=" " read USED AVAIL TOTAL <<<$(free -htm | grep "Mem" | awk {'print $3,$7,$2'})
# get processes
PROCESS=`ps -eo user=|sort|uniq -c | awk '{ print $2 " " $1 }'`
PROCESS_ALL=`echo "$PROCESS"| awk {'print $2'} | awk '{ SUM += $1} END { print SUM }'`
PROCESS_ROOT=`echo "$PROCESS"| grep root | awk {'print $2'}`
PROCESS_USER=`echo "$PROCESS"| grep -v root | awk {'print $2'} | awk '{ SUM += $1} END { print SUM }'`
# get processors
PROCESSOR_NAME=`grep "model name" /proc/cpuinfo | cut -d ' ' -f3- | awk {'print $0'} | head -1`
PROCESSOR_COUNT=`grep -ioP 'processor\t:' /proc/cpuinfo | wc -l`
#get ipv4
ipaddr=$(ip addr show eth0 | grep "inet\b" | awk '{print $2}' | cut -d/ -f1)

#SSH
checkSSH=`echo "Currently $(who -q | cut -c "9-11" | sed "1 d") user(s) logged in."`

#CPU_TEMP
checkCPU=$(</sys/class/thermal/thermal_zone0/temp)
checkCPU=$(echo "${checkCPU} 100 0.1" | awk '{printf "%.2f\n", $1/$2*$3}')
if [ "$degrees" == "F" ]; then
            cpu=$(echo "1.8 $cpu 32" | awk '{printf "%.2f\n", $1*$2+$3}')
        fi

#vnstat
vnstatM=`vnstat -m | grep \`date +"%b"\` | awk '{print $9,$10}'`
vnstatV=`vnstat -m | grep \`date +"%b"\` | awk '{print $12,$13}'`

lastLogin=`last -i | grep -v 'still logged in' | grep 'pts' | head -3 | awk '{print "\\\e[92mLast Logins.:\\\e[39m\\\e[96m",$10,$7,$6,$5,$1,"=>\\\e[31m",$3,"\\\e[39m"}'`

W="\e[0;39m"
G="\e[1;32m"
echo -e "Welcolme to"
/usr/bin/env figlet -c -f slant "$(hostname)"


echo -e "
${W}system info:
$W  Distro...................: $W`cat /etc/*release | grep "PRETTY_NAME" | cut -d "=" -f 2- | sed 's/"//g'`
$W  Kernel...................: $W`uname -sr`
$W  Uptime...................: $W`uptime -p`
$W  Processes................: $W$G$PROCESS_ROOT$W (root), $G$PROCESS_USER$W (user), $G$PROCESS_ALL$W (total)
$W  CPU......................: $W$PROCESSOR_NAME ($G$PROCESSOR_COUNT$W vCPU)
$W  CPU Temp.................: $W$G${checkCPU}$WÂ°$G${degrees}$W
$W  Memory...................: $G$USED$W used, $G$AVAIL$W avail, $G$TOTAL$W total$W
$W  Bandwidth Use............: ${vnstatM} used this month. ${vnstat}
$W  IP Addresses.............: $W${ipaddr} and `wget -q -O - http://icanhazip.com/ | tail`
$W  SSH logins...............: $W${checkSSH}
	${lastLogin}
"
#services
# set column width
COLUMNS=3
# colors
green="\e[1;32m"
red="\e[1;31m"
undim="\e[0m"
declare -a services=(
"fail2ban"
"ufw"
"tor"
"wg-quick@wg0"
"unbound"
"pihole-FTL"
)
declare -a serviceName=(
"fail2ban"
"ufw"
"tor"
"wireguard"
"unbound"
"pihole"
)
declare -a serviceStatus=()



service_status=()
# get status of all services
for service in "${services[@]}"; do
    serviceStatus+=($(systemctl is-active "$service.service"))
done

out=""
for i in ${!serviceStatus[@]}; do
    # color green if service is active, else red
    if [[ "${serviceStatus[$i]}" == "active" ]]; then
        out+="${serviceName[$i]}:,${green}${serviceStatus[$i]}${undim},"
    else
        out+="${serviceName[$i]}:,${red}${serviceStatus[$i]}${undim},"
    fi
    # insert \n every $COLUMNS column
    if [ $((($i+1) % $COLUMNS)) -eq 0 ]; then
        out+="\n"
    fi
done
out+="\n"

printf "\nservices:\n"
printf "$out" | column -ts $',' | sed -e 's/^/  /'

# config
max_usage=90
bar_width=50
# colors
white="\e[39m"
green="\e[1;32m"
red="\e[1;31m"
dim="\e[2m"
undim="\e[0m"

# disk usage: ignore zfs, squashfs & tmpfs
mapfile -t dfs < <(df -H -x zfs -x squashfs -x tmpfs -x devtmpfs -x overlay --output=target,pcent,size | tail -n+2)
printf "\ndisk usage:\n"

for line in "${dfs[@]}"; do
    # get disk usage
    usage=$(echo "$line" | awk '{print $2}' | sed 's/%//')
    used_width=$((($usage*$bar_width)/100))
    # color is green if usage < max_usage, else red
    if [ "${usage}" -ge "${max_usage}" ]; then
        color=$red
    else
        color=$green
    fi
    # print green/red bar until used_width
    bar="[${color}"
    for ((i=0; i<$used_width; i++)); do
        bar+="="
    done
    # print dimmmed bar until end
    bar+="${white}${dim}"
    for ((i=$used_width; i<$bar_width; i++)); do
        bar+="="
    done
    bar+="${undim}]"
    # print usage line & bar
    echo "${line}" | awk '{ printf("%-31s%+3s used out of %+4s\n", $1, $2, $3); }' | sed -e 's/^/  /'
    echo -e "${bar}" | sed -e 's/^/  /'
done

FILE='/var/log/fail2ban.log*'
if test -f "$FILE"; then
logfile='/var/log/fail2ban.log*'
mapfile -t lines < <(grep -hioP '(\[[a-z-]+\]) ?(?:restore)? (ban|unban)' $logfile | sort | uniq -c)
jails=($(printf -- '%s\n' "${lines[@]}" | grep -oP '\[\K[^\]]+' | sort | uniq))

out=""
for jail in ${jails[@]}; do
    bans=$(printf -- '%s\n' "${lines[@]}" | grep -iP "[[:digit:]]+ \[$jail\] ban" | awk '{print $1}')
    restores=$(printf -- '%s\n' "${lines[@]}" | grep -iP "[[:digit:]]+ \[$jail\] restore ban" | awk '{print $1}')
    unbans=$(printf -- '%s\n' "${lines[@]}" | grep -iP "[[:digit:]]+ \[$jail\] unban" | awk '{print $1}')
    bans=${bans:-0} # default value
    restores=${restores:-0} # default value
    unbans=${unbans:-0} # default value
    bans=$(($bans+$restores))
    diff=$(($bans-$unbans))
    out+=$(printf "$jail, %+3s bans, %+3s unbans, %+3s active" $bans $unbans $diff)"\n"
done

printf "\nfail2ban status (monthly):\n"
printf "$out" | column -ts $',' | sed -e 's/^/  /'
else
printf "\nNice! fail2ban don't have any logs yet\n"
fi
